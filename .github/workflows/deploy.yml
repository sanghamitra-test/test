name: Build and Deploy to AKS

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install dependencies
      run: npm install

    - name: Build React app
      run: npm run build

    - name: Log in to Azure Container Registry
      run: echo "k8/2hMfAeKsdRvF18yAUcBzaybLD1kpBaYBRiLsUXy+ACRC/PGC8" | docker login k8autopilot.azurecr.io -u k8autopilot --password-stdin

    - name: Build and push Docker image
      run: |
        docker build -t k8autopilot.azurecr.io/react-app:${{ github.sha }} .
        docker push k8autopilot.azurecr.io/react-app:${{ github.sha }}

    - name: Deploy to AKS
      run: |
        kubectl apply -f deployment.yaml
      env:
        KUBECONFIG: |
          apiVersion: v1
          clusters:
          - cluster:
              certificate-authority-data: |
                LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUU2RENDQXRDZ0F3SUJBZ0lRWEtKOWpDMW1KVXB4RXBaRWR6dmgxREFOQmdrcWhraUc5dzBCQVFzRkFEQU4KTVFzd0NRWURWUVFERXdKallUQWdGdzB5TkRFeE1URXdOek14TWpkYUdBOHlNRFUwTVRFeE1UQTNOREV5TjFvdwpEVEVMTUFrR0ExVUVBeE1DWTJFd2dnSWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUNEd0F3Z2dJS0FvSUNBUUNsCkhLVFZ2T2lsUmE2TXFQMWVIWFZNMnRuSmM1TnowblRuSWg3M3pjQVc0MUtaOGtQUW5CTGdkYzRlRnlNVHliYTUKa1luVlplRGNENXJnYkY3VWdHdDBubGx5KzQrOHZ2V0x5a3ZGSHEvYnNoaXFWUUJ2ZnI5Q0k3czR4Y2FPdWtDZgpXRWRBaHRUY2FEMFF6dUtaaDhkNFRKck5MRFZ2alBMWDFaazBGdzRnOElqWnRCMEw5UUpaYlUzOVdUa0VZYzJhCnhQK0NveDZiS3JKNzdBclZ4aHhwc0tlaEpOaFpnMm0zalI4V1A5QVFrMHdhOXJFM1lJN2xsZVRLZ2NGMGxWZ0sKTHdUQlMyTTFMNXZrb05nUFBrME9BWTdDc1pVUTlQeEJHTXR2a0NjLzVRSHJDTFl4R3hVdHNPSjlVVFBFTFhPOQpqVm1UaWU3YVVLUHVSeCtuUHNtRldhWUFXWnBZcU43Vk04NkwyZWVQcmhZZkl2ak5ZS2p5dG5EcGR5WUpnWXdtClpMVmkvZUpzdUtWK1NXOTFSS0RKTDJCVGVPcExBY21IV1FlMnNtYWlHN0ZEcEhqNXk3Tjc0NkxYUFRDSzJEeE0KeW0vQkxKY0ZFaDI2WUJTcVhUdko5Q3pjWmQ0RXFOcERpMUZuQjFxckd1M0NVSW1mV2owVXNPbVdWSUhaUnNwdgpYaWx2ZWpleFE0L05XOTNFY0RmbERBVDVRYm1OUDh6ckFieW9FZS9SdFc1THFSTUVTT245UHVsYmpMeG5wc3JECnBCbks3SzJlR254UVRqc0dORkhqT2hxQW5QTDAzUFZVNEZGNzIwdm9XSWZZRFhTdHZHZ1VZVFVDcDB2UmYwTGcKVDBFbTMwMmRpQ0g0Q3VyRDRJZnM4UFBNZ0lBSnRjVmlYdUlQS0VJdFZRSURBUUFCbzBJd1FEQU9CZ05WSFE4QgpBZjhFQkFNQ0FxUXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QWRCZ05WSFE0RUZnUVVXVkd4RkVQL2hHQzdzVmhDClk5ZFlnb0xCbng0d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dJQkFKYXl3N3RpNHNPYU5nU0VSekhuMHBBUWtIdVoKcjF3N2VHTFhpUGdEOE45T0ttOW5rVVorcXdIWDR3dXlEbXU3VzlOQ1VJbENkeTA4N01nT0Zka2dlRnpQeDRrLwoxUHpmTnU5R05oRjVJclFvSXRWbGtISGVZZUg5N1lBenpoN1NTaTEweXJwRmdRL041VStrNTVUdWRTYUhWOHh5CnY1NUs0dW1vY25wcnBNNXdLdXF0bFAzaGxOblgrZitxNW4xNjIyQVJUby9Fd3JPV1hJcmJRbTR1ZWQ0L1gyTGwKRlJ2Qit1UytaZFE1VDVpbXgxQVVNRmtLdmViQTBQNXo0RkZtN1VadEtzTHQ4aVpmVThMTm9FUzhDNlhqTTUzTApBR1ZUS3E2S0wwLzEvMTZEWGpUaUhvNFRZWVhCQ3VwVXE5VHordDVBbE0wRTlRRlMyK1E3M1k2ejBHdGFQeTh1Cnk5cUdUWm1XT3Y3TEY2WHJaVnRFdXBUQnllREQzcGxlV1VvSUUrSWIyayt5OVBFVXNOMzVmZ1FsbUZDVTBLdksKQm1hZDhYSndETmpQbVJ3RlFVbGl6RTUxL205bVR5TDUrb1ZTcUpyYVJhOUxzY0lkS2M2bnRrUGU4L055ZG1XMApXYVR2VnFsWjFpRThabHdBT1RZSEJzaU1ZM3p5a0hYMnN6OStEVitIQUNPQXFHWGNDbzVWT1JMeFBqWHdtOVNsCitEY1ZkUDBnOEhwWFdrc0VSSG9jN1o1SnhEb2xUa0VSZ3Jvd1kxQndtV3d4OS9ZcDZydGJmL2pGZkxDeEViZ0UKYVc4NFJQR2wxZnZueGR3T3BvS3RjeVBoQ0x1c1ZsMHlpYTJOQWNTa1BnOXVaemtjSDB4M0xDVWtKWlNkTHhsZAovNjlaVlZKck8venBraVpjCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
              server: https://mycluster-dns-o9xnr5fq.954bef4c-b8eb-452b-a94b-c44012f3a80c.privatelink.eastus.azmk8s.io:443
            name: mycluster
          contexts:
          - context:
              cluster: mycluster
              user: clusterUser_rg-kubernetes-autopilot_mycluster
            name: mycluster
          current-context: mycluster
          kind: Config
          preferences: {}
          users:
          - name: clusterUser
            user:
              client-certificate-data: |
                LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZIakNDQXdhZ0F3SUJBZ0lSQVB2RE12TFR5cGtOVDVJUlJjTFdLWFl3RFFZSktvWklodmNOQVFFTEJRQXcKRFRFTE1Ba0dBMVVFQXhNQ1kyRXdIaGNOTWpReE1URXhNRGN6TVRJM1doY05Nall4TVRFeE1EYzBNVEkzV2pBdwpNUmN3RlFZRFZRUUtFdzV6ZVhOMFpXMDZiV0Z6ZEdWeWN6RVZNQk1HQTFVRUF4TU1iV0Z6ZEdWeVkyeHBaVzUwCk1JSUNJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBZzhBTUlJQ0NnS0NBZ0VBMjE1Wm1qWEY2OXpQaFpPdmZPZysKdjZZVTRrZmw3MDRia1dpSjVIaVNkVHgxQTJsMXZNb2ZWUm1sNk5Ic0JybHQrZVVSK2JuUktaMFJ2Rzd3enAyZwpNL0V0NkgrNEtncWZtZEJXVEVCOHg2M1htMy96YjErR1BvZUtlQ0pEdHNra2tKSFZBN05xTjlEUGZqbDk3NUt1CkEzL3l4Snd6UjhFRTdNNVE2OUpROWFGaStEUlVOaURKcmRvSnR6N2JYVkhoTTQyWDVsZmpJU0hSdHpIZWFxUkoKN1A4eEtqcHpQYUtQRWdmRnlTd05uVnF6SVFwMEliZTVHSWxNbm41d25PUjdXTXNGd2dNR0V4VVJJQm9ldzR5OAozT2FKWlVhQ3JNVjFHTmtwR0ZPalRPcXdOeTFqN25TTkRxbURmczh4UEhCcUlnR2hrbFRPTjdiSDNHR1FtUElNCmc4aEVORXV3OUQ2THdicW5HNmFUQVpqODVOdXh5aW4yUERFanprbHVSQkIzVEp3Z3VhSDFxVVRmRmtDVTVwVXQKYVhNMkEzQnVFY2hXWnVlNzl6dHRoSGJZZUdoQnBueFJOUm9scWswRHFtbExWUTlkN0RHQThud0dBTGZQd1g4UAoxNEZ0QWlsNzVwOEhkREdLUUJUWnNBZGpQRzc2aXUvRnRETnJHZVU1YnpMQk9GN0NkQ05vNjRyUGxzampOWnFCClZpaUdFei9aMGxMaGo0MEEwcGlGS3BzY3ZzRTNRSFRVS0VXWGFXcWxRUmJ6KzdoR3g2NXpJenJScGpBY0kvNEQKcnFlZmd6RE9YRW5LMHBKMnM1WG91UTlNRjFmMGRKd2QwVmM3MEVEVGZ5d0Q0a3ZLakg1dUZVZVNFbklaY3JDNQppN3g3dFlvSzArbklzZ2ZFY1F5blJJRUNBd0VBQWFOV01GUXdEZ1lEVlIwUEFRSC9CQVFEQWdXZ01CTUdBMVVkCkpRUU1NQW9HQ0NzR0FRVUZCd01DTUF3R0ExVWRFd0VCL3dRQ01BQXdId1lEVlIwakJCZ3dGb0FVV1ZHeEZFUC8KaEdDN3NWaENZOWRZZ29MQm54NHdEUVlKS29aSWh2Y05BUUVMQlFBRGdnSUJBQ2ZZM0U3c2xHZ1dqVmZnL0MyZQpiTzl2T3Y2bmZkbitYcWM3alFLck1ibUJzenlVQTBnZVdkQy9zVVFjNVAyRFAreGNha2FYZUZOWjBCcW44ei9KCnZEdm44dU9NNk1xbnh5Mm8rTWgwUytSZkVhWGo0UklNZXpTOVpyK3VGVFJBSis0U0p1Y3czL0xFTWo3Q1dncWgKZythbENoNVR3VVZRSGxOakVJdkUrUjJSSFNicEhZeis3cWV6SVpCd291RzRTdzBNYldiOGhHaldpVnhJVzVLdwpWTnhLUXJXeVdFVlVUWGxpcklJcUZvWEEzZVF2TkdqN2hTeVdjenY2bkJ2NCtadlFwa3NYMVp4TGtyRklHVjhmCi9lTS95WU9JTWk4VlhiZzhJeWVjTG9QYmVqSCs0RUk0aTk5NWNOS3hTR3pQSWdFL3lFZElab0hibjlGdDZGZGUKeDBkUlQyNDlZME9WVWFrWFhIVEQxdmVuSUJHOGdERytSM0k1OXlCWUtNTjZTUGJjQzQ5N3Z1aFp3VFgzdXNaMwpVQmVmcmdlTVRvNDkvRTArKzVOYUZJd25Cd1EwSHpGYkJPTHZNQlRwMGlGRms1c2ZCaXczQVVSbVBaY2VrZ21aClBKazNUUTVrMGhnMURvalZlMlN6OTc0ZXdwNlNjUnFlNU5teXZvSlZtUWlPUHJwSTF0aEtIcFpET2piclN1Z3QKSG9odnZIS3dMVlVxNHIwT0tZVkV6K0tOblNmQUtBbXNDYmFCYWZ4VFBnam1DMlVuMXhtQXdVYUFOL05td0pyYgpUWSs1d0RWeWc3dzlSaXNoV01LWkN3ZDJaWXYxZThrL245WE95T3Y1UTdyNFVRMk0vQ3ZNaVltSVlHRUZXRnZVCmI5V3VidWh3ZnFyRGVGZ296dHBIL1lzdQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
              client-key-data: |
                LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlKSndJQkFBS0NBZ0VBMjE1Wm1qWEY2OXpQaFpPdmZPZyt2NllVNGtmbDcwNGJrV2lKNUhpU2RUeDFBMmwxCnZNb2ZWUm1sNk5Ic0JybHQrZVVSK2JuUktaMFJ2Rzd3enAyZ00vRXQ2SCs0S2dxZm1kQldURUI4eDYzWG0zL3oKYjErR1BvZUtlQ0pEdHNra2tKSFZBN05xTjlEUGZqbDk3NUt1QTMveXhKd3pSOEVFN001UTY5SlE5YUZpK0RSVQpOaURKcmRvSnR6N2JYVkhoTTQyWDVsZmpJU0hSdHpIZWFxUko3UDh4S2pwelBhS1BFZ2ZGeVN3Tm5WcXpJUXAwCkliZTVHSWxNbm41d25PUjdXTXNGd2dNR0V4VVJJQm9ldzR5ODNPYUpaVWFDck1WMUdOa3BHRk9qVE9xd055MWoKN25TTkRxbURmczh4UEhCcUlnR2hrbFRPTjdiSDNHR1FtUElNZzhoRU5FdXc5RDZMd2Jxbkc2YVRBWmo4NU51eAp5aW4yUERFanprbHVSQkIzVEp3Z3VhSDFxVVRmRmtDVTVwVXRhWE0yQTNCdUVjaFdadWU3OXp0dGhIYlllR2hCCnBueFJOUm9scWswRHFtbExWUTlkN0RHQThud0dBTGZQd1g4UDE0RnRBaWw3NXA4SGRER0tRQlRac0FkalBHNzYKaXUvRnRETnJHZVU1YnpMQk9GN0NkQ05vNjRyUGxzampOWnFCVmlpR0V6L1owbExoajQwQTBwaUZLcHNjdnNFMwpRSFRVS0VXWGFXcWxRUmJ6KzdoR3g2NXpJenJScGpBY0kvNERycWVmZ3pET1hFbkswcEoyczVYb3VROU1GMWYwCmRKd2QwVmM3MEVEVGZ5d0Q0a3ZLakg1dUZVZVNFbklaY3JDNWk3eDd0WW9LMCtuSXNnZkVjUXluUklFQ0F3RUEKQVFLQ0FnQmo4RkwvNTFtWS84cm5Qd1ltOEtPTnFqcy9iNlA0WnV3MlRacnNwR1dNMVpNMWo3a2MzalJ5RDdJLwpKRXZVTUd4QytiSTd4QVRmWVhod0VWYlJ1b3YrdmZTOVJGcUJoTDk3VXFmT0sxN3RsV3h4b2xRa1BDK3JreEpwCmNxckl2bEJUTUswTDk1UC9nN2pUOTV0Qkp1RHlKVHRUaVJudnFhYjF2M1NzU3UrcFIvSVB3NzlOdlpoRUJONkMKUmplb0J5S0MyeElGMWFwYk1NNGJHTFFNZjNaU2ExeFpzYkZJdGlOYUFvS0FDUHJXNGpoVGFEREtINnBLM0ZvMApwc1BsSms1dmdHYktJWmlGM3dZalN1TVRFYTRGTVY0TTdwZWY0SUZkWmFuTU5HWmtKMU5LZi9wVDYzTkw1N3hKCmJGa3hBTUhKWmxiV2xKNHlVYW94NDV6OW9PQkQzV0s3UWRGS3haMU9TcFNGQUpMU3lpaldvNWZ5TjJDOVFEbXMKaTNTdmticlAwMXM1eWN2dnp1SWlpcXpPOUFWWlg0RmNQbExBbnUyOWhYd2E4b3NXWE4vb1dEbFlMWnVHNjY3cApsWWFuY2dXc0RYU05nTzlZa2ZhSWRmUkltdVRCL0ZQVDBlZ2pzdkJ2VCtUdVBzdUExNXljQWZENmkwUUhCekRmClYrdTFMM0RmYk1ZVUthc2JSMlJudDh3ajY5WHdwcUQzLytJanlWNXV1VDJnSENENlk1UG0yQXRYSXdvdnpqSW4KQitWSGZYSWt1NDgyMWFkOXhvK3cwbUhwbVhUekJUZkFERWx5MTNLYVVSU2ppZ1lkWGlhcGxnYmJFM0dvZVFjUwp4RDB5L2Nqd1h0aWdweHlXT1hmb29oZTlOYVFSOWhPUGVrNTBJM1d6ZGdPR1ZFK3NBUUtDQVFFQTZBTHVoM3cwCm1rRFJrOXBGRzlQRU54cHJxUXJlbVh5a0ZVWWQwWXoxanJSU2IyckRxbDJnSlBsVFo5R3F5L3FxN1psRERPYUMKRFZJQ0hpSFhPNVZEL2svSmVsQVNhNldnNVdENjU1cGxzak9OKzBFV0FpVUJHSlBzTkRFeWxFQXhuaCt1bGE1cAo0MWhjandqeWZhNFVoV2F0ZktIcXozZmRwRTFPZWY3ek1YY0U1UHkxQmw2NHJtNFM3a3orZ1JOMzJCZGQvby9zCmdVNjZYYm5zaVVYY3RHODZqUGVQbjZTUGkrQUVEcDMzYlZya0VXRUU5M3o1MFErTHl4Qm1iZS9TV2dOUXdBWU4Kb3BSSWtrNWNtRXVFLyt3T0M0eFJzclJMTkdjZnUyOHVNVTZUbzJvNXBJeis4aG92U3M2QjFnbU9sd3NJZEljRApHdFNrSmpIOXlXY1c0UUtDQVFFQThnekdsdEZ0dFIxWmtGVkVDdGFyZ25QaWxHYkphUmdUQ1pxRExhQWlTVUVkCnZTK0lnQWRxL2ZwN09DNlR3anUrWnpPdmRSdFFCdVZSSWkxQkwwQlBKbk5rUmRMR3daZkd6UHFmaDdTNjhHa1IKckV5d2pITllub1ZnaFRETnZTaXhNQjYxRDB3Ykcwa0JkWVhTREJLOG5zOGs0enJnbm9kUkt4VCtMZzlFL2Q1RgpLS0ZrZUJoM2MwRmNZR0UvQjlwdVNZOG43Ni9RUkc2RkxFcEdIbFFjQlNwSTNNeUZQeStmcG03eEpQSHpxbVBXCkk1V0M0WUVFYnAvV1dXVlM3Qm1NdTYzZHZvZHhPYXBLOXoya01obUkxdW5ybTlFNGp4NmFjVVdDdTIxQjJzVVoKZjk4cWgyS0EzaXlkRHpJdlBLVTB0dU55RmduY1pzYzBCN3hvMGhzQm9RS0NBUUFNTjVOTjZSbHdBZmZIUEZnbApSZnB3R0dFUTdyU1lDbnN0YjVyRVhSTFZKK09yWUVqYllNQzlFYS8xcUpIQTJmdEVOYXpWTWhJcEYyZHJKTWNMCnFTbUNhN3NsU0xBZm9RSWU4Z05rVExvTUx6REx5VHFhZEU1aGQvQ1pNdm9CMm51Q1l4S3phUkxFV1BQT3lGN1UKaFdVcFBTWG5pVE12SjVXeFFDemd1YThlckxEQ1NoaFNOSXl2Q3JiT2U1bHZQSkl6Kzg4RVI1bmhtVDZ4RHNoSQoxamZ2L0dkdDR0OWFQYlVkWFhkNU9aSTgzT3RqaXVOVEVPNnF0cEhhNklzc1FOT256OExoeWEvUUh0VFBkM2JpCndoOUh4cXRhcWxIbkFoMXZyZnA2eVRqNmViUEdpQ0p1NnNuRi8rRDdwSElyemljSEJ4cXo0Q1FtdG9uS1JSbWoKRUYyaEFvSUJBRTQrUlAvQnlVWHZxK0VWUHY2RjhFRW1Oc3NrQXQxL0U4QloreWVIaVMzRzU5Y2RBM0huYy9XUAp2NzhraDAwVlJQSlZhZFZnTTlsV3pZaFB1cStNaVVsenFhbE1ma1ZjUzc0OUVjNnJaSGFNY0ZNVEkwcnppbVVMCjFteVhueG9UaWx0MHdiQ2xPR24waW8wejZmZFBJenZ1MkF6QUhwWUFSZ080TUlZeEYyczlLM3Y3MTk5ZWdWWjMKZldZR2FYcWZhR0ZNN21yem1VNVZyNlRtaVk0S1FGaUhGN0NRU0U1cGxhRVdZY3RBanpTNE95T2JsQWhUVFZ4NQpQSy8vS2ZQNk9sejgwaDVoNS83dEJuaXZxMkVxa2VwdkNXT0FHVmxpV2loZGdPb1hZbDlXc1d4OWRtRDNQWk1VCk50MFBxdWRldkJDV3EyMW1XS0c4cVJ3TEVwTkFlYUVDZ2dFQWZZNkgwYll4bE1vbEgzMkJCbmpXeGRuRnd0ZVAKTllYUWNKNGlPV3FRSW9KNnZNaFRlOXV3L0xVdXZaK0hWcGlneFlOanJnWnRiRTRsOTdVS2FjbE03RGVveVZoSQo5Ui9UNDVEY29NVmcwYXhtNnNuRVREblBIU1gvdHdITXEvSVJMelhLTmNDcUhHME1sTnNBbXY5bnQ0dEFFNXAzCnZpa1hqaVBtaFgycm9IMVI2ejZKa1BVY3VUaFRmY3NtWUd5VHMrRDhGTlROTkwwSml0dExXMVlURXBZaHg4c2YKTHNBbjFQZnNudEkrbmx3VjhXVFZUU1RYcDlWeHNybGUzbGlrUFBUSlpGR2ZlVHR0NExpYzlTSHpOSzBLTUkwUgo4alovSm5lclZrbjdndUJqV01CRU9oOEp4djRKa2cwM1oxQzdGTVVzdHJOdDFMaWpoVkxTN2hzVHNnPT0KLS0tLS1FTkQgUlNBIFBSSVZBVEUgS0VZLS0tLS0K
              token: |
                63zmh6a2x1ejrcnrf3csdpyzrg7goitv3ufaj91tcu9pz0km78vndtunsp2j5ncw5o5ddy51jj2kis2s75c84uqewnc3krclr2cxkm1tp69axk94aq3ihdfslv9mkql2
